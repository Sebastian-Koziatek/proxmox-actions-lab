name: Alma

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Akcja do wykonania'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy
      vm_number:
        description: 'Numer maszyny (1, 1-5, 1,3,5, ALL)'
        required: true
        default: 'ALL'
jobs:
  terraform:
    name: ZarzÄ…dzanie VM Alma
    runs-on: self-hosted
    defaults:
      run:
        working-directory: Alma
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Restore Terraform state from Git backup
        run: |
          if [ ! -f terraform.tfstate ] && [ -f .terraform-state-backup ]; then
            echo "\033[1;36mPrzywracanie stanu Terraform z backup w Git...\033[0m"
            cp .terraform-state-backup terraform.tfstate
            echo "Stan przywrÃ³cony z backup!"
          else
            echo "Brak backupu w Git lub stan juÅ¼ istnieje"
          fi

      - name: Instalacja Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform init
        run: |
          echo "CzyszczÄ™ lokalny cache Terraform (moduÅ‚y / plan)";
          rm -rf .terraform .terraform.lock.hcl || true
          terraform init
        env:
          TF_VAR_proxmox_api_token: ${{ secrets.PROXMOX_API_TOKEN }}

      - name: Terraform Apply/Destroy (na wzÃ³r Jenkins)
        run: |
          set -e
          
          echo "ğŸ” DEBUG: Wybrana akcja: '${{ github.event.inputs.action }}'"
          echo "ğŸ” DEBUG: Wybrane VM: '${{ github.event.inputs.vm_number }}'"
          
          # Funkcja do parsowania zakresÃ³w (1-5, 1,3,5, etc.)
          parse_vm_numbers() {
            local input="$1"
            if [ "$input" = "ALL" ]; then
              echo "1 2 3 4 5 6 7 8 9 10 11 12 13 14 15"
            elif [[ "$input" =~ ^[0-9]+-[0-9]+$ ]]; then
              # Zakres typu 1-5
              local start=$(echo "$input" | cut -d'-' -f1)
              local end=$(echo "$input" | cut -d'-' -f2)
              seq $start $end | tr '\n' ' '
            elif [[ "$input" =~ ^[0-9,]+$ ]]; then
              # Lista typu 1,3,5
              echo "$input" | tr ',' ' '
            else
              # Pojedynczy numer
              echo "$input"
            fi
          }
          
          vm_list=$(parse_vm_numbers "${{ github.event.inputs.vm_number }}")
          echo "ğŸ¯ Przetwarzanie VM: $vm_list"
          
          for vm_num in $vm_list; do
            echo "ğŸš€ Przetwarzanie VM #$vm_num"
            echo "ğŸ” DEBUG: Akcja = '${{ github.event.inputs.action }}'"
            
            if [ "${{ github.event.inputs.action }}" = "apply" ]; then
              echo "âœ… WykonujÄ™ APPLY dla VM #$vm_num"
              terraform apply -auto-approve -target=module.vm[\"$vm_num\"] -var="zakres=$vm_num"
            else
              echo "âŒ WykonujÄ™ DESTROY dla VM #$vm_num"
              terraform destroy -auto-approve -target=module.vm[\"$vm_num\"] -var="zakres=$vm_num"
            fi
            
            # OpÃ³Åºnienie miÄ™dzy VM (ale nie po ostatniej)
            if [ "$vm_num" != "$(echo $vm_list | awk '{print $NF}')" ]; then
              echo "â³ OpÃ³Åºnienie 15 sekund miÄ™dzy maszynami"
              sleep 15
            fi
          done
        env:
          TF_VAR_proxmox_api_token: ${{ secrets.PROXMOX_API_TOKEN }}

      - name: SprawdÅº czy plik stanu powstaÅ‚
        run: |
          echo "=== DIAGNOSTYKA PLIKU STANU ==="
          pwd
          ls -la
          if [ -f terraform.tfstate ]; then
            echo "âœ… Plik terraform.tfstate istnieje - rozmiar: $(ls -lh terraform.tfstate | awk '{print $5}')"
            echo "ğŸ“ PeÅ‚na Å›cieÅ¼ka: $(realpath terraform.tfstate)"
            echo "ğŸ” Uprawnienia: $(ls -l terraform.tfstate)"
            echo "ğŸ“„ Pierwsze 3 linie pliku:"
            head -3 terraform.tfstate || echo "Nie moÅ¼na odczytaÄ‡ pliku"
          else
            echo "âŒ Plik terraform.tfstate NIE istnieje!"
            echo "ğŸ“ Pliki w katalogu:"
            ls -la | grep terraform || echo "Brak plikÃ³w terraform w katalogu"
          fi
          echo "================================"

      - name: Upload Terraform state (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state-alma
          path: Alma/terraform.tfstate
          retention-days: 30
        if: success() || failure()

      - name: Backup Terraform state to Git (Alma)
        run: |
          if [ -f terraform.tfstate ] && [ -n "${{ secrets.GH_PAT }}" ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            cp terraform.tfstate .terraform-state-backup
            git add .terraform-state-backup
            if git diff --staged --quiet; then
              echo "Stan Terraform nie zmieniÅ‚ siÄ™ - pomijam commit"
            else
              git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/Sebastian-Koziatek/Terraform-Proxmox.git
              git commit -m "Backup terraform state po ${GITHUB_JOB} (VM: ${{ github.event.inputs.vm_number }})"
              git push
            fi
          else
            echo "Brak pliku terraform.tfstate lub tokena GH_PAT, backup pominiÄ™ty."
          fi