name: Install Zabbix On Monitoring VMs

on:
  workflow_dispatch:
    inputs:
      vm_range:
        description: "Zakres VM (np. 2-13, 2,4,6 lub ALL)"
        required: true
        default: "2-13"
      ssh_port:
        description: "Port SSH"
        required: true
        default: "22"
      ssh_user:
        description: "Uzytkownik SSH"
        required: true
        default: "szkolenie"

jobs:
  install:
    name: Install Zabbix Script
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure ssh tools
        run: |
          set -e
          if ! command -v ssh >/dev/null 2>&1; then
            sudo apt-get update -qq
            sudo apt-get install -y openssh-client
          fi
          if ! command -v scp >/dev/null 2>&1; then
            sudo apt-get update -qq
            sudo apt-get install -y openssh-client
          fi
          if ! command -v sshpass >/dev/null 2>&1; then
            sudo apt-get update -qq
            sudo apt-get install -y sshpass
          fi

      - name: Install script on selected VMs
        env:
          VM_RANGE: ${{ github.event.inputs.vm_range }}
          SSH_PORT: ${{ github.event.inputs.ssh_port }}
          SSH_USER: ${{ github.event.inputs.ssh_user }}
          SSH_PASSWORD: ${{ secrets.LAB_SSH_PASSWORD }}
        run: |
          set -euo pipefail

          if [ -n "${SSH_PASSWORD:-}" ]; then
            echo "::add-mask::$SSH_PASSWORD"
          fi

          parse_vm_numbers() {
            local input="$1"
            if [ "$input" = "ALL" ]; then
              seq 1 15 | tr '\n' ' '
            elif [[ "$input" =~ ^[0-9]+-[0-9]+$ ]]; then
              local start end
              start=$(echo "$input" | cut -d'-' -f1)
              end=$(echo "$input" | cut -d'-' -f2)
              seq "$start" "$end" | tr '\n' ' '
            elif [[ "$input" =~ ^[0-9,]+$ ]]; then
              echo "$input" | tr ',' ' '
            else
              echo "$input"
            fi
          }

          vm_list=$(parse_vm_numbers "$VM_RANGE")
          echo "Selected VM numbers: $vm_list"

          success_vms=()
          failed_vms=()

          for vm_num in $vm_list; do
            octet=$((60 + vm_num))
            ip="10.123.1.${octet}"
            echo "--- VM #$vm_num ($ip) ---"

            ssh_opts=(-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=15 -p "$SSH_PORT")

            auth_mode=""
            if ssh "${ssh_opts[@]}" -o BatchMode=yes "$SSH_USER@$ip" "echo connected" >/dev/null 2>&1; then
              auth_mode="key"
              echo "Auth: SSH key"
            elif [ -n "${SSH_PASSWORD:-}" ]; then
              if sshpass -p "$SSH_PASSWORD" ssh "${ssh_opts[@]}" "$SSH_USER@$ip" "echo connected" >/dev/null 2>&1; then
                auth_mode="password"
                echo "Auth: SSH password"
              fi
            fi

            if [ -z "$auth_mode" ]; then
              echo "[ERROR] Brak polaczenia SSH do $ip"
              failed_vms+=("$vm_num")
              continue
            fi

            if [ "$auth_mode" = "key" ]; then
              if ! scp "${ssh_opts[@]}" scripts/install_zabbix_server.sh "$SSH_USER@$ip:/tmp/install_zabbix_server.sh"; then
                echo "[ERROR] SCP nieudane dla VM #$vm_num"
                failed_vms+=("$vm_num")
                continue
              fi

              if ssh "${ssh_opts[@]}" "$SSH_USER@$ip" "chmod +x /tmp/install_zabbix_server.sh && sudo -n /tmp/install_zabbix_server.sh --yes"; then
                success_vms+=("$vm_num")
              else
                echo "[ERROR] Instalacja nieudana na VM #$vm_num (key auth, sudo bez hasla wymagane)"
                failed_vms+=("$vm_num")
              fi
            else
              if ! sshpass -p "$SSH_PASSWORD" scp "${ssh_opts[@]}" scripts/install_zabbix_server.sh "$SSH_USER@$ip:/tmp/install_zabbix_server.sh"; then
                echo "[ERROR] SCP nieudane dla VM #$vm_num"
                failed_vms+=("$vm_num")
                continue
              fi

              if sshpass -p "$SSH_PASSWORD" ssh "${ssh_opts[@]}" "$SSH_USER@$ip" "chmod +x /tmp/install_zabbix_server.sh && sudo -S -p '' /tmp/install_zabbix_server.sh --yes" <<<"$SSH_PASSWORD"; then
                success_vms+=("$vm_num")
              else
                echo "[ERROR] Instalacja nieudana na VM #$vm_num"
                failed_vms+=("$vm_num")
              fi
            fi

            echo "--- done VM #$vm_num ---"
          done

          echo ""
          echo "Success VMs: ${success_vms[*]:-none}"
          echo "Failed VMs:  ${failed_vms[*]:-none}"

          if [ ${#failed_vms[@]} -gt 0 ]; then
            exit 1
          fi
