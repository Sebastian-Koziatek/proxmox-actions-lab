name: Install Zabbix On Monitoring VMs

on:
  workflow_dispatch:
    inputs:
      vm_range:
        description: "Zakres VM (np. 2-13, 2,4,6 lub ALL)"
        required: true
        default: "2-13"
      ssh_port:
        description: "Port SSH (np. 22 albo 22,60601)"
        required: true
        default: "22,60601"
      ssh_user:
        description: "Uzytkownik SSH"
        required: true
        default: "szkolenie"

jobs:
  install:
    name: Install Zabbix Script
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install script on selected VMs
        env:
          VM_RANGE: ${{ github.event.inputs.vm_range }}
          SSH_PORT: ${{ github.event.inputs.ssh_port }}
          SSH_USER: ${{ github.event.inputs.ssh_user }}
          SSH_PASSWORD: ${{ secrets.LAB_SSH_PASSWORD }}
        run: |
          set -euo pipefail

          command -v ssh >/dev/null 2>&1 || { echo "[ERROR] Brak binarki ssh"; exit 1; }
          command -v scp >/dev/null 2>&1 || { echo "[ERROR] Brak binarki scp"; exit 1; }
          command -v setsid >/dev/null 2>&1 || { echo "[ERROR] Brak binarki setsid"; exit 1; }

          if [ -n "${SSH_PASSWORD:-}" ]; then
            echo "::add-mask::$SSH_PASSWORD"
          fi

          ASKPASS_FILE="$(mktemp)"
          cat >"$ASKPASS_FILE" <<'EOF'
#!/bin/sh
printf '%s\n' "${SSH_PASSWORD:?}"
EOF
          chmod 700 "$ASKPASS_FILE"
          trap 'rm -f "$ASKPASS_FILE"' EXIT

          parse_vm_numbers() {
            local input="$1"
            if [ "$input" = "ALL" ]; then
              seq 1 15 | tr '\n' ' '
            elif [[ "$input" =~ ^[0-9]+-[0-9]+$ ]]; then
              local start end
              start=$(echo "$input" | cut -d'-' -f1)
              end=$(echo "$input" | cut -d'-' -f2)
              seq "$start" "$end" | tr '\n' ' '
            elif [[ "$input" =~ ^[0-9,]+$ ]]; then
              echo "$input" | tr ',' ' '
            else
              echo "$input"
            fi
          }

          vm_list=$(parse_vm_numbers "$VM_RANGE")
          port_list=$(echo "$SSH_PORT" | tr ',' ' ')

          echo "Selected VM numbers: $vm_list"
          echo "Port candidates: $port_list"

          success_vms=()
          failed_vms=()

          for vm_num in $vm_list; do
            octet=$((60 + vm_num))
            ip="10.123.1.${octet}"
            echo "--- VM #$vm_num ($ip) ---"

            auth_mode=""
            selected_port=""

            for port in $port_list; do
              ssh_opts=(-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=15 -p "$port")

              if ssh "${ssh_opts[@]}" -o BatchMode=yes "$SSH_USER@$ip" "echo connected" >/dev/null 2>&1; then
                auth_mode="key"
                selected_port="$port"
                break
              fi

              if [ -n "${SSH_PASSWORD:-}" ]; then
                if env SSH_PASSWORD="$SSH_PASSWORD" DISPLAY=:0 SSH_ASKPASS="$ASKPASS_FILE" SSH_ASKPASS_REQUIRE=force \
                  setsid ssh "${ssh_opts[@]}" "$SSH_USER@$ip" "echo connected" </dev/null >/dev/null 2>&1; then
                  auth_mode="password"
                  selected_port="$port"
                  break
                fi
              fi
            done

            if [ -z "$auth_mode" ]; then
              echo "[ERROR] Brak polaczenia SSH do $ip (porty: $SSH_PORT)"
              failed_vms+=("$vm_num")
              continue
            fi

            echo "Auth: $auth_mode, port: $selected_port"
            ssh_opts=(-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=15 -p "$selected_port")

            if [ "$auth_mode" = "key" ]; then
              if ! scp "${ssh_opts[@]}" scripts/install_zabbix_server.sh "$SSH_USER@$ip:/tmp/install_zabbix_server.sh"; then
                echo "[ERROR] SCP nieudane dla VM #$vm_num"
                failed_vms+=("$vm_num")
                continue
              fi

              if ssh "${ssh_opts[@]}" "$SSH_USER@$ip" "chmod +x /tmp/install_zabbix_server.sh && sudo -n /tmp/install_zabbix_server.sh --yes"; then
                success_vms+=("$vm_num")
              else
                echo "[ERROR] Instalacja nieudana na VM #$vm_num (key auth, sudo bez hasla wymagane)"
                failed_vms+=("$vm_num")
              fi
            else
              if ! env SSH_PASSWORD="$SSH_PASSWORD" DISPLAY=:0 SSH_ASKPASS="$ASKPASS_FILE" SSH_ASKPASS_REQUIRE=force \
                setsid scp "${ssh_opts[@]}" scripts/install_zabbix_server.sh "$SSH_USER@$ip:/tmp/install_zabbix_server.sh" </dev/null >/dev/null 2>&1; then
                echo "[ERROR] SCP nieudane dla VM #$vm_num"
                failed_vms+=("$vm_num")
                continue
              fi

              if printf '%s\n' "$SSH_PASSWORD" | env SSH_PASSWORD="$SSH_PASSWORD" DISPLAY=:0 SSH_ASKPASS="$ASKPASS_FILE" SSH_ASKPASS_REQUIRE=force \
                setsid ssh "${ssh_opts[@]}" "$SSH_USER@$ip" "chmod +x /tmp/install_zabbix_server.sh && sudo -S -p '' /tmp/install_zabbix_server.sh --yes"; then
                success_vms+=("$vm_num")
              else
                echo "[ERROR] Instalacja nieudana na VM #$vm_num"
                failed_vms+=("$vm_num")
              fi
            fi

            echo "--- done VM #$vm_num ---"
          done

          echo ""
          echo "Success VMs: ${success_vms[*]:-none}"
          echo "Failed VMs:  ${failed_vms[*]:-none}"

          if [ ${#failed_vms[@]} -gt 0 ]; then
            exit 1
          fi
